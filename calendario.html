<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Escolar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <py-config>
        packages = ["pyodide-http"]
    </py-config>
    <style>
        /* --- Variables de Color para los Temas --- */
        :root {
            --bg-page: #e2e8f0;
            /* slate-200 */
            --bg-card: #f8fafc;
            /* slate-50 */
            --bg-header: #4f46e5;
            /* indigo-600 */
            --bg-table-header: #334155;
            /* slate-700 */
            --bg-table-row-alt: #f1f5f9;
            /* slate-100 */
            --bg-table-row: #ffffff;
            /* white */
            --text-header: #ffffff;
            /* white */
            --text-title: #3730a3;
            /* indigo-800 */
            --text-body: #475569;
            /* slate-600 */
            --text-muted: #64748b;
            /* slate-500 */
            --border-color: #cbd5e1;
            /* slate-300 */
            --accent-color: #6366f1;
            /* indigo-500 */
            --accent-hover: #4338ca;
            /* indigo-700 */
        }

        .theme-dark {
            --bg-page: #1e293b;
            /* slate-800 */
            --bg-card: #334155;
            /* slate-700 */
            --bg-header: #0f172a;
            /* slate-900 */
            --bg-table-header: #000000;
            /* black */
            --bg-table-row-alt: #334155;
            /* slate-700 */
            --bg-table-row: #475569;
            /* slate-600 */
            --text-header: #e2e8f0;
            /* slate-200 */
            --text-title: #93c5fd;
            /* blue-300 */
            --text-body: #cbd5e1;
            /* slate-300 */
            --text-muted: #94a3b8;
            /* slate-400 */
            --border-color: #475569;
            /* slate-600 */
            --accent-color: #2563eb;
            /* blue-600 */
            --accent-hover: #1d4ed8;
            /* blue-700 */
        }

        .theme-ocean {
            --bg-page: #e0f2fe;
            /* sky-100 */
            --bg-card: #f0f9ff;
            /* sky-50 */
            --bg-header: #0c4a6e;
            /* sky-900 */
            --bg-table-header: #075985;
            /* sky-800 */
            --bg-table-row-alt: #f0f9ff;
            /* sky-50 */
            --bg-table-row: #ffffff;
            /* white */
            --text-header: #ffffff;
            /* white */
            --text-title: #0369a1;
            /* sky-700 */
            --text-body: #075985;
            /* sky-900 */
            --text-muted: #38bdf8;
            /* sky-400 */
            --border-color: #bae6fd;
            /* sky-200 */
            --accent-color: #0ea5e9;
            /* sky-500 */
            --accent-hover: #0284c7;
            /* sky-600 */
        }

        .theme-forest {
            --bg-page: #f0fdf4;
            /* green-50 */
            --bg-card: #fefce8;
            /* yellow-50 */
            --bg-header: #14532d;
            /* green-900 */
            --bg-table-header: #166534;
            /* green-800 */
            --bg-table-row-alt: #f0fdf4;
            /* green-50 */
            --bg-table-row: #ffffff;
            /* white */
            --text-header: #dcfce7;
            /* green-100 */
            --text-title: #3f6212;
            /* lime-800 */
            --text-body: #365314;
            /* lime-900 */
            --text-muted: #84cc16;
            /* lime-500 */
            --border-color: #dcfce7;
            /* green-100 */
            --accent-color: #4d7c0f;
            /* lime-700 */
            --accent-hover: #365314;
            /* lime-900 */
        }

        .theme-sunset {
            --bg-page: #fff7ed;
            /* orange-50 */
            --bg-card: #fef2f2;
            /* red-50 */
            --bg-header: #4c1d95;
            /* violet-900 */
            --bg-table-header: #5b21b6;
            /* violet-800 */
            --bg-table-row-alt: #fff7ed;
            /* orange-50 */
            --bg-table-row: #ffffff;
            /* white */
            --text-header: #f5d0fe;
            /* fuchsia-200 */
            --text-title: #c2410c;
            /* orange-600 */
            --text-body: #9a3412;
            /* orange-800 */
            --text-muted: #ea580c;
            /* orange-500 */
            --border-color: #fed7aa;
            /* orange-200 */
            --accent-color: #f97316;
            /* orange-500 */
            --accent-hover: #c2410c;
            /* orange-600 */
        }

        .theme-graphite {
            --bg-page: #171717;
            /* neutral-900 */
            --bg-card: #262626;
            /* neutral-800 */
            --bg-header: #000000;
            /* black */
            --bg-table-header: #171717;
            /* neutral-900 */
            --bg-table-row-alt: #262626;
            /* neutral-800 */
            --bg-table-row: #404040;
            /* neutral-700 */
            --text-header: #e5e5e5;
            /* neutral-200 */
            --text-title: #a3e635;
            /* lime-400 */
            --text-body: #d4d4d4;
            /* neutral-300 */
            --text-muted: #a3a3a3;
            /* neutral-400 */
            --border-color: #525252;
            /* neutral-600 */
            --accent-color: #84cc16;
            /* lime-500 */
            --accent-hover: #a3e635;
            /* lime-400 */
        }

        /* --- Ajustes específicos para temas --- */
        .theme-graphite #theme-selector {
            background-color: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .theme-graphite #theme-selector option {
            background-color: var(--bg-card);
            color: var(--text-body);
        }

        .theme-graphite button.bg-green-600 {
            background-color: var(--accent-color);
            color: #171717;
            /* neutral-900 */
        }

        .theme-graphite button.bg-green-600:hover {
            background-color: var(--accent-hover);
        }

        .theme-graphite button.bg-red-600 {
            background-color: #ef4444;
            /* red-500 */
        }

        .theme-graphite button.bg-red-600:hover {
            background-color: #dc2626;
            /* red-600 */
        }

        /* --- Aplicación de Variables a la UI --- */
        body {
            background-color: var(--bg-page);
        }

        header,
        #modal-close-btn {
            background-color: var(--bg-header);
            color: var(--text-header);
        }

        h1,
        h2,
        h3,
        #modal-title {
            color: var(--text-title);
        }

        p,
        .text-gray-600 {
            color: var(--text-body);
        }

        .text-gray-500,
        .italic {
            color: var(--text-muted);
        }

        .bg-slate-50,
        .bg-white,
        aside,
        #activity-modal>div {
            background-color: var(--bg-card);
        }

        .bg-slate-200 {
            background-color: var(--bg-page);
        }

        .bg-slate-300 {
            background-color: var(--border-color);
        }

        .bg-slate-100 {
            background-color: var(--bg-table-row-alt);
        }

        .border-slate-300 {
            border-color: var(--border-color);
        }

        .border-slate-500 {
            border-color: var(--text-muted);
        }

        #horario-body .bg-white {
            background-color: var(--bg-table-row);
        }

        #horario-body .bg-slate-100 {
            background-color: var(--bg-table-row-alt);
        }

        #horario-body .font-medium {
            color: var(--text-title);
        }

        thead.bg-slate-700 {
            background-color: var(--bg-table-header);
        }

        thead.bg-slate-700 th {
            color: var(--text-header);
        }

        button.bg-indigo-500,
        button.bg-indigo-600 {
            background-color: var(--accent-color);
        }

        button.hover\:bg-indigo-600:hover,
        button.hover\:bg-indigo-700:hover {
            background-color: var(--accent-hover);
        }

        #calendario-grid .bg-slate-50 {
            background-color: var(--bg-card);
        }

        #calendario-grid .bg-slate-200 {
            background-color: var(--bg-page);
        }

        #calendario-grid .border-slate-200 {
            border-color: var(--bg-page);
        }

        /* Para que el selector de tema se vea bien en todos los temas */
        #theme-selector {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
        }

        #theme-selector option {
            background-color: var(--bg-header);
            color: var(--text-header);
        }
    </style>
</head>

<body class="p-4 transition-colors duration-300">

    <header class="text-center p-4 rounded-lg shadow-lg relative">
        <h1 class="text-3xl sm:text-5xl font-extrabold tracking-tight" style="color: var(--text-header);">Calendario
            Evaluaciones
            4to B</h1>
        <p class="text-sm" style="color: var(--text-header); opacity: 0.8;">v2.0 - Carga desde Google Sheets</p>
        <!-- Ajuste de posición para el selector de tema en móviles -->
        <div class="absolute top-2 right-2 sm:top-2 sm:right-4">
            <select id="theme-selector" class="text-sm">
                <option value="default">Tema: Por Defecto</option>
                <option value="theme-dark">Tema: Oscuro</option>
                <option value="theme-ocean">Tema: Océano</option>
                <option value="theme-forest">Tema: Bosque</option>
                <option value="theme-sunset">Tema: Atardecer</option>
                <option value="theme-graphite">Tema: Grafito</option>
            </select>
        </div>
    </header>

    <main class="container mx-auto max-w-7xl mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2">
            <div class="flex justify-between items-center mb-4 px-1">
                <button id="prev-day-btn"
                    class="px-3 py-1 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 text-sm">
                    <span class="hidden sm:inline">&lt; Día Anterior</span>
                    <span class="sm:hidden">&lt;</span>
                </button>
                <h2 class="text-xl sm:text-2xl font-bold text-indigo-800 text-center">Vista Semanal</h2>
                <button id="next-day-btn"
                    class="px-3 py-1 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 text-sm">
                    <span class="hidden sm:inline">Día Siguiente &gt;</span>
                    <span class="sm:hidden">&gt;</span>
                </button>
            </div>
            <!-- Contenedor para scroll horizontal en móviles -->
            <div class="overflow-x-auto pb-4">
                <!-- El grid ahora tiene un ancho mínimo para forzar el scroll -->
                <div id="vista-semanal" class="grid grid-cols-7 gap-2 min-w-[800px] lg:min-w-full">
                    <div
                        class="bg-slate-50 p-3 rounded-lg shadow-lg min-h-[100px] flex items-center justify-center text-gray-400">
                        Cargando...</div>
                </div>
            </div>

            <!-- INICIO: Nueva sección de Vista Mensual -->
            <div class="mt-8">
                <h2 class="text-xl sm:text-2xl font-bold text-indigo-800 mb-4">Vista Mensual</h2>
                <div class="bg-slate-100 p-4 rounded-lg shadow-lg">
                    <div id="calendario-header" class="flex justify-between items-center mb-4"></div>
                    <div id="calendario-grid" class="grid grid-cols-7 gap-1"></div>
                </div>
            </div>
            <!-- FIN: Nueva sección de Vista Mensual -->

            <div class="mt-8 mb-4">
                <h2 class="text-xl sm:text-2xl font-bold text-indigo-800">Horario de Clases</h2>
            </div>

            <div class="bg-slate-50 rounded-lg shadow-lg">
                <table class="w-full text-center text-gray-600">
                    <thead class="text-xs text-white uppercase bg-slate-700 font-semibold">
                        <tr>
                            <th class="px-1 sm:px-4 py-3 border-r border-slate-500 text-[10px] sm:text-xs">Hora</th>
                            <th class="px-1 sm:px-4 py-3 border-r border-slate-500 text-[10px] sm:text-xs">Lunes</th>
                            <th class="px-1 sm:px-4 py-3 border-r border-slate-500 text-[10px] sm:text-xs">Martes</th>
                            <th class="px-1 sm:px-4 py-3 border-r border-slate-500 text-[10px] sm:text-xs">Miércoles
                            </th>
                            <th class="px-1 sm:px-4 py-3 border-r border-slate-500 text-[10px] sm:text-xs">Jueves</th>
                            <th class="px-1 sm:px-4 py-3 text-[10px] sm:text-xs">Viernes</th>
                        </tr>
                    </thead>
                    <tbody id="horario-body" class="align-middle text-[10px] sm:text-sm">
                        <tr class="border-b border-slate-300 bg-white">
                            <td class="px-1 py-1 sm:px-2 sm:py-2 font-medium bg-slate-100 border-r border-slate-300">
                                8:00-8:45</td>
                            <td data-asignatura="Ciencias" class="px-1 py-1 sm:px-2 sm:py-2 border-r border-slate-300"
                                rowspan="2">
                                Ciencias</td>
                            <td data-asignatura="Matematicas"
                                class="px-1 py-1 sm:px-2 sm:py-2 border-r border-slate-300" rowspan="2">
                                Matemáticas</td>
                            <td data-asignatura="Ingles" class="px-1 py-1 sm:px-2 sm:py-2 border-r border-slate-300"
                                rowspan="2">Inglés
                            </td>
                            <td data-asignatura="Religion" class="px-1 py-1 sm:px-2 sm:py-2 border-r border-slate-300">
                                Religión</td>
                            <td data-asignatura="Ed. Fisica" class="px-1 py-1 sm:px-2 sm:py-2" rowspan="2">Ed. Física
                            </td>
                        </tr>
                        <tr class="border-b border-slate-300 bg-white">
                            <td class="px-1 py-1 sm:px-2 sm:py-2 font-medium bg-slate-100 border-r border-slate-300">
                                8:45-9:30</td>
                            <td data-asignatura="Lenguaje" class="px-1 py-1 sm:px-2 sm:py-2 border-r border-slate-300">
                                Lenguaje</td>
                        </tr>
                        <tr class="border-b border-slate-300 bg-slate-100">
                            <td class="px-1 py-1 sm:px-2 sm:py-2 font-medium border-r border-slate-300">9:30-9:45</td>
                            <td colspan="5" class="px-1 py-1 sm:px-2 sm:py-2 text-slate-500 italic">Recreo</td>
                        </tr>
                        <tr class="border-b border-slate-300 bg-white">
                            <td class="px-1 py-1 sm:px-2 sm:py-2 font-medium bg-slate-100 border-r border-slate-300">
                                9:45-10:30</td>
                            <td data-asignatura="Musica" class="px-1 py-1 sm:px-2 sm:py-2 border-r border-slate-300"
                                rowspan="2">Música
                            </td>
                            <td data-asignatura="Orientacion"
                                class="px-1 py-1 sm:px-2 sm:py-2 border-r border-slate-300">Orientación
                            </td>
                            <td data-asignatura="Lenguaje" class="px-1 py-1 sm:px-2 sm-py-2 border-r border-slate-300"
                                rowspan="2">
                                Lenguaje</td>
                            <td data-asignatura="Lenguaje" class="px-1 py-1 sm:px-2 sm-py-2 border-r border-slate-300"
                                rowspan="2">
                                Lenguaje</td>
                            <td data-asignatura="Ed. Fisica" class="px-1 py-1 sm:px-2 sm:py-2">Ed. Física</td>
                        </tr>
                        <tr class="border-b border-slate-300 bg-white">
                            <td class="px-1 py-1 sm:px-2 sm:py-2 font-medium bg-slate-100 border-r border-slate-300">
                                10:30-11:15</td>
                            <td data-asignatura="Religion" class="px-1 py-1 sm:px-2 sm:py-2 border-r border-slate-300">
                                Religión</td>
                            <td data-asignatura="Lenguaje" class="px-1 py-1 sm:px-2 sm:py-2">Lenguaje</td>
                        </tr>
                        <tr class="border-b border-slate-300 bg-slate-100">
                            <td class="px-1 py-1 sm:px-2 sm:py-2 font-medium border-r border-slate-300">11:15-11:30</td>
                            <td colspan="5" class="px-1 py-1 sm:px-2 sm:py-2 text-slate-500 italic">Recreo</td>
                        </tr>
                        <tr class="border-b border-slate-300 bg-white">
                            <td class="px-1 py-1 sm:px-2 sm:py-2 font-medium bg-slate-100 border-r border-slate-300">
                                11:30-12:15</td>
                            <td data-asignatura="Artes" class="px-1 py-1 sm:px-2 sm:py-2 border-r border-slate-300"
                                rowspan="2">Artes
                            </td>
                            <td data-asignatura="Ingles" class="px-1 py-1 sm:px-2 sm:py-2 border-r border-slate-300"
                                rowspan="2">Inglés
                            </td>
                            <td data-asignatura="Tecnologia" class="px-1 py-1 sm:px-2 sm:py-2 border-r border-slate-300"
                                rowspan="2">
                                Tecnología</td>
                            <td data-asignatura="Ingles" class="px-1 py-1 sm:px-2 sm:py-2 border-r border-slate-300"
                                rowspan="2">Inglés
                            </td>
                            <td data-asignatura="Historia" class="px-1 py-1 sm:px-2 sm:py-2">Historia</td>
                        </tr>
                        <tr class="border-b border-slate-300 bg-white">
                            <td class="px-1 py-1 sm:px-2 sm:py-2 font-medium bg-slate-100 border-r border-slate-300">
                                12:15-13:00</td>
                            <td data-asignatura="Ciencias" class="px-1 py-1 sm:px-2 sm:py-2">Ciencias</td>
                        </tr>
                        <tr class="border-b border-slate-300 bg-slate-100">
                            <td class="px-1 py-1 sm:px-2 sm:py-2 font-medium border-r border-slate-300">13:00-14:00</td>
                            <td colspan="5" class="px-1 py-1 sm:px-2 sm:py-2 text-slate-500 italic">Almuerzo</td>
                        </tr>
                        <tr class="border-b border-slate-300 bg-white">
                            <td class="px-1 py-1 sm:px-2 sm:py-2 font-medium bg-slate-100 border-r border-slate-300">
                                14:00-14:45</td>
                            <td data-asignatura="Lenguaje" class="px-1 py-1 sm:px-2 sm:py-2 border-r border-slate-300"
                                rowspan="2">
                                Lenguaje</td>
                            <td data-asignatura="Historia" class="px-1 py-1 sm:px-2 sm:py-2 border-r border-slate-300"
                                rowspan="2">
                                Historia</td>
                            <td data-asignatura="Matematicas"
                                class="px-1 py-1 sm:px-2 sm:py-2 border-r border-slate-300" rowspan="2">
                                Matemáticas</td>
                            <td data-asignatura="Matematicas"
                                class="px-1 py-1 sm:px-2 sm:py-2 border-r border-slate-300" rowspan="2">
                                Matemáticas</td>
                            <td class="px-1 py-1 sm:px-2 sm:py-2" rowspan="2"></td>
                        </tr>
                        <tr class="bg-white">
                            <td class="px-1 py-1 sm:px-2 sm:py-2 font-medium bg-slate-100 border-r border-slate-300">
                                14:45-15:30</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <aside class="bg-slate-50 p-6 rounded-lg shadow-lg">
            <h3 class="text-xl font-bold text-indigo-800 mb-4">Anuncios Importantes</h3>
            <ul id="lista-anuncios" class="space-y-3">
                <li class="text-gray-500">Cargando...</li>
            </ul>

            <!-- INICIO: Nueva sección de Leyenda y Resumen -->
            <div class="mt-8 pt-6 border-t border-slate-300">
                <h3 class="text-xl font-bold text-indigo-800 mb-4">Leyenda y Resumen</h3>
                <ul id="leyenda-resumen" class="space-y-3 text-sm">
                    <li class="text-gray-500">Cargando...</li>
                </ul>
            </div>
            <!-- FIN: Nueva sección de Leyenda y Resumen -->
        </aside>
    </main>

    <!-- INICIO: Modal para detalles de actividad -->
    <div id="activity-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm sm:max-w-md">
            <h3 id="modal-title" class="text-2xl font-bold text-indigo-800 mb-4"></h3>
            <div id="modal-body" class="text-gray-700 space-y-2 mb-6" style="white-space: pre-wrap;">
            </div>
            <button id="modal-close-btn"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">
                Cerrar
            </button>
        </div>
    </div>
    <!-- FIN: Modal -->

    <script type="py">
        import json
        import csv
        import io
        from datetime import datetime, timedelta
        import asyncio
        from js import document, localStorage, console, alert
        from pyodide.ffi import create_proxy
        import calendar

        todas_las_actividades = []
        # Variable global para el estado del calendario mensual
        vista_actual = datetime.now()
        # Nueva variable para el inicio de la vista semanal
        semana_actual_inicio = datetime.now()
        # Nueva variable para el filtro de resaltado
        categoria_resaltada_actualmente = None

        # URL de la hoja de Google Sheets publicada como CSV
        GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRl0jRb88eGWEDFxclwwDxH1Nm42csypWI42KJt3td0N2PBEO5NTx0pVO3ilcI-3TpATPVM_PWw4Wij/pub?output=csv"

        def get_color_for_activity(act):
            descripcion = act.get('descripcion', '').lower()
            asignatura = act.get('asignatura', '').lower()

            if 'control de lectura' in descripcion:
                return "bg-fuchsia-600 text-white" # Fucsia para Control de Lectura
            if 'no hay clases' in descripcion or 'feriado' in descripcion:
                return "bg-red-200 text-red-800"
            if 'evaluación' in descripcion or 'prueba' in descripcion or 'control' in descripcion:
                return "bg-orange-500 text-white"
            if 'trabajo práctico' in descripcion:
                return "bg-sky-100 text-sky-800"
            if asignatura == 'evento':
                return "bg-purple-100 text-purple-800"
            
            return "bg-teal-100 text-teal-800"

        def get_category_for_activity(act):
            descripcion = act.get('descripcion', '').lower()
            asignatura = act.get('asignatura', '').lower()
            if 'no hay clases' in descripcion or 'feriado' in descripcion: return 'libres'
            if 'evaluación' in descripcion or 'prueba' in descripcion or 'control' in descripcion: return 'evaluaciones'
            if 'trabajo práctico' in descripcion: return 'trabajos'
            if asignatura == 'evento': return 'eventos'
            return 'tareas'



        def renderizar_vista_semanal():
            global semana_actual_inicio
            contenedor = document.getElementById('vista-semanal')
            contenedor.innerHTML = ''
            dias_semana_nombres = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo']

            for i in range(7):
                fecha_actual = semana_actual_inicio + timedelta(days=i)
                fecha_iso = fecha_actual.strftime('%Y-%m-%d')
                
                actividades_html = ""
                act_del_dia = [act for act in todas_las_actividades if act['fecha'] == fecha_iso]
                
                if act_del_dia:
                    # Ordenar actividades para consistencia
                    act_del_dia_sorted = sorted(act_del_dia, key=lambda x: x['asignatura'])
                    for act in act_del_dia_sorted:
                        # Preparar datos para el modal
                        act_data = json.dumps(act).replace('"', "&quot;")
                        color_clases = get_color_for_activity(act)
                        categoria_act = get_category_for_activity(act)
                        # Abreviar el nombre de la asignatura a la primera palabra
                        asignatura_corta = act["asignatura"].split(' ')[0]
                        actividades_html += f"""<li class="activity-item {color_clases} px-1 py-2 rounded-md mt-2 text-[10px] leading-tight text-center font-semibold shadow-sm truncate cursor-pointer" data-category="{categoria_act}"
                                                 data-activity='{act_data}' title="Click para ver detalles">{asignatura_corta}</li>"""
                
                dia_html = (
                    f'<div class="day-cell bg-slate-50 p-3 rounded-lg shadow-lg min-h-[100px]">'
                    f'<h4 class="font-bold text-center text-sm">{dias_semana_nombres[fecha_actual.weekday()]}</h4>'
                    f'<p class="text-center text-xs text-gray-500 mb-2">{fecha_actual.strftime("%d/%m")}</p>'
                    f'<ul class="list-none p-0">{actividades_html}</ul>'
                    '</div>'
                )
                contenedor.innerHTML += dia_html
            
            # Añadir listeners a los botones de la semana
            document.getElementById('prev-day-btn').addEventListener('click', create_proxy(cambiar_dia_semanal))
            document.getElementById('next-day-btn').addEventListener('click', create_proxy(cambiar_dia_semanal))
            
            # Añadir listeners para los items de actividad (para el modal)
            for item in document.querySelectorAll('#vista-semanal .activity-item'):
                item.addEventListener('click', create_proxy(mostrar_modal))

        def renderizar_vista_mensual():
            global vista_actual
            header = document.getElementById('calendario-header')
            grid = document.getElementById('calendario-grid')
            
            mes_actual = vista_actual.month
            anio_actual = vista_actual.year
            
            # Renderizar cabecera (Mes, Año y botones)
            meses_es = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
            header.innerHTML = f"""
                <button id="prev-month-btn" class="px-3 py-1 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">&lt;</button>
                <h3 class="text-xl font-bold text-indigo-800">{meses_es[mes_actual - 1]} {anio_actual}</h3>
                <button id="next-month-btn" class="px-3 py-1 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">&gt;</button>
            """
            
            # Renderizar días de la semana
            grid.innerHTML = ''
            dias_semana_cortos = ['Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sá', 'Do']
            for dia in dias_semana_cortos:
                grid.innerHTML += f'<div class="text-center font-bold text-gray-600 text-sm py-2">{dia}</div>'

            # Obtener el calendario del mes
            matriz_mes = calendar.monthcalendar(anio_actual, mes_actual)

            for semana in matriz_mes:
                for dia in semana:
                    if dia == 0:
                        grid.innerHTML += '<div class="border border-slate-200 rounded-lg bg-slate-200"></div>' # Celda vacía
                    else:
                        fecha_iso = f"{anio_actual}-{str(mes_actual).zfill(2)}-{str(dia).zfill(2)}"
                        actividades_del_dia_html = ""
                        act_del_dia = [act for act in todas_las_actividades if act['fecha'] == fecha_iso]
                        clase_hoy = "bg-amber-200" if fecha_iso == datetime.now().strftime('%Y-%m-%d') else ""
                        clase_fondo_dia = "bg-slate-50"

                        # Comprobar si es un día sin clases para colorear el fondo
                        es_dia_libre = any('no hay clases' in act.get('descripcion', '').lower() or 'feriado' in act.get('descripcion', '').lower() for act in act_del_dia)
                        if es_dia_libre:
                            clase_fondo_dia = "bg-red-100"
                        
                        # Comprobar si es un día con Control de Lectura
                        es_control_lectura = any('control de lectura' in act.get('descripcion', '').lower() for act in act_del_dia)
                        if es_control_lectura:
                            clase_fondo_dia = "bg-fuchsia-300"
                        
                        for act in act_del_dia:
                            # Limpiar descripción para el tooltip y el contenido
                            descripcion_limpia = act['descripcion'].replace(' | ', ' ').replace('|', ' ')
                            # Preparar datos para el modal
                            act_data = json.dumps(act).replace('"', "&quot;")
                            color_clases = get_color_for_activity(act)
                            categoria_act = get_category_for_activity(act)

                            actividades_del_dia_html += f"""
                            <div class="activity-item {color_clases} p-0.5 rounded mt-0.5 text-[4px] sm:text-[9px] whitespace-normal shadow-sm cursor-pointer" data-category="{categoria_act}"
                                  data-activity='{act_data}' title="Click para ver detalles">
                                <strong class="font-semibold">{act['asignatura']}:</strong> {descripcion_limpia}
                            </div>
                            """
                        
                        grid.innerHTML += f"""
                        <div class="day-cell flex flex-col border border-slate-300 {clase_fondo_dia} rounded-lg p-1 aspect-square {clase_hoy} overflow-hidden">
                            <span class="font-medium text-gray-800 text-[10px] sm:text-xs">{dia}</span>
                            <div class="overflow-y-auto flex-grow min-h-0">{actividades_del_dia_html}</div>
                        </div>
                        """
            
            # Añadir listeners a los nuevos botones
            document.getElementById('prev-month-btn').addEventListener('click', create_proxy(cambiar_mes))
            document.getElementById('next-month-btn').addEventListener('click', create_proxy(cambiar_mes))
            
            # Añadir listeners para los items de actividad (para el modal)
            for item in document.querySelectorAll('#calendario-grid .activity-item'):
                item.addEventListener('click', create_proxy(mostrar_modal))

        def mostrar_modal(e):
            modal = document.getElementById('activity-modal')
            # Usamos currentTarget para asegurarnos de obtener el div al que se le añadió el listener
            activity_data_str = e.currentTarget.getAttribute('data-activity')
            activity_data = json.loads(activity_data_str)
            
            document.getElementById('modal-title').innerText = activity_data['asignatura']
            # Reemplazar los separadores '|' por saltos de línea para una mejor lectura
            descripcion_formateada = activity_data['descripcion'].replace(' | ', '\n').replace('|', '\n')
            document.getElementById('modal-body').innerText = descripcion_formateada
            
            modal.classList.remove('hidden')
            modal.classList.add('flex')

        def cerrar_modal(e):
            modal = document.getElementById('activity-modal')
            # Cerrar si se hace clic fuera del contenido del modal o en el botón de cerrar
            if e.target == modal or e.target.id == 'modal-close-btn':
                modal.classList.add('hidden')
                modal.classList.remove('flex')

        def cambiar_mes(e):
            global vista_actual
            mes_actual = vista_actual.month
            anio_actual = vista_actual.year
            
            if e.target.id == 'prev-month-btn':
                vista_actual = vista_actual.replace(day=1) - timedelta(days=1)
            else: # next-month-btn
                vista_actual = vista_actual.replace(day=28) + timedelta(days=4)
            renderizar_vista_mensual()
            renderizar_leyenda_y_resumen() # Actualizar el resumen al cambiar de mes
        
        def cambiar_dia_semanal(e):
            global semana_actual_inicio
            if e.target.id == 'prev-day-btn':
                semana_actual_inicio -= timedelta(days=1)
            else: # next-day-btn
                semana_actual_inicio += timedelta(days=1)
            renderizar_vista_semanal()
            resaltar_categoria_actual() # Mantener el resaltado al navegar


        def resaltar_categoria(e):
            global categoria_resaltada_actualmente
            categoria_seleccionada = e.currentTarget.getAttribute('data-category')

            # Si se hace clic en la misma categoría, se desactiva el filtro
            if categoria_seleccionada == categoria_resaltada_actualmente:
                categoria_resaltada_actualmente = None
            else:
                categoria_resaltada_actualmente = categoria_seleccionada
            
            resaltar_categoria_actual()
            renderizar_leyenda_y_resumen() # Para actualizar el estilo de la leyenda

        def resaltar_categoria_actual():
            # Quitar resaltado de todas las celdas de día
            for day_cell in document.querySelectorAll('.day-cell'):
                day_cell.classList.remove('ring-4', 'ring-blue-500', 'shadow-xl', 'z-10', 'relative')
                day_cell.classList.add('opacity-50')

            if categoria_resaltada_actualmente:
                # Aplicar resaltado a las celdas de día que contienen la categoría
                for day_cell in document.querySelectorAll('.day-cell'):
                    if day_cell.querySelector(f'[data-category="{categoria_resaltada_actualmente}"]'):
                        day_cell.classList.add('ring-4', 'ring-blue-500', 'shadow-xl', 'z-10', 'relative')
                        day_cell.classList.remove('opacity-50')
            else: # Si no hay filtro, mostrar todas las celdas normalmente
                for day_cell in document.querySelectorAll('.day-cell'):
                    day_cell.classList.remove('opacity-50')


        def resaltar_horario():
            # Se elimina el resaltado automático para mantener un estilo profesional y consistente.
            celdas = document.querySelectorAll('#horario-body td[data-asignatura]')
            for celda in celdas:
                celda.classList.remove('bg-amber-100', 'font-bold')

        def renderizar_anuncios():
            contenedor = document.getElementById('lista-anuncios')
            contenedor.innerHTML = ''
            hoy = datetime.now()
            limite = hoy + timedelta(days=30)
            fecha_hoy_iso = hoy.strftime('%Y-%m-%d')
            fecha_limite_iso = limite.strftime('%Y-%m-%d')

            keywords_materiales = ['material', 'traer', 'vestimenta', 'guia']
            asignaturas_especiales = ['artes visuales', 'tecnología']
            
            anuncios = []
            for act in todas_las_actividades:
                # Check if the activity is within the next 30 days
                if not (fecha_hoy_iso <= act['fecha'] <= fecha_limite_iso):
                    continue

                descripcion_lower = act.get('descripcion', '').lower()
                asignatura_lower = act.get('asignatura', '').lower()

                # Condición 1: Asignaturas especiales o palabras clave
                if any(asig in asignatura_lower for asig in asignaturas_especiales) or \
                   any(keyword in descripcion_lower for keyword in keywords_materiales):
                    anuncios.append(act)

            anuncios_ordenados = sorted(anuncios, key=lambda x: x['fecha'])

            if not anuncios_ordenados:
                contenedor.innerHTML = '<li class="text-gray-500">No hay anuncios próximos.</li>'
                return

            for evento in anuncios_ordenados:
                fecha_obj = datetime.strptime(evento['fecha'], '%Y-%m-%d')
                # Limpiar descripción para el anuncio
                descripcion_anuncio = evento['descripcion'].replace(' | ', ' - ').replace('|', ' ')
                contenedor.innerHTML += f"""
                <li class="relative p-4 bg-yellow-200 rounded-lg shadow-md border-l-4 border-yellow-400">
                    <i class="fas fa-thumbtack absolute top-2 right-2 text-yellow-600 text-lg"></i>
                    <p class="font-bold text-yellow-900">{evento['asignatura']}</p>
                    <p class="text-sm text-yellow-800 mt-1">{descripcion_anuncio}</p>
                    <p class="text-xs text-yellow-700 mt-2 font-semibold">{fecha_obj.strftime('%d/%m/%Y')}</p>
                </li>
                """

        def renderizar_leyenda_y_resumen():
            global vista_actual
            contenedor = document.getElementById('leyenda-resumen')
            contenedor.innerHTML = ''

            mes_actual = vista_actual.month
            anio_actual = vista_actual.year

            # Filtrar actividades para que correspondan solo al mes y año en vista
            actividades_del_mes = [
                act for act in todas_las_actividades
                if datetime.strptime(act['fecha'], '%Y-%m-%d').month == mes_actual and datetime.strptime(act['fecha'], '%Y-%m-%d').year == anio_actual
            ]

            counts = {'evaluaciones': 0, 'trabajos': 0, 'eventos': 0, 'tareas': 0, 'libres': 0}

            for act in actividades_del_mes:
                categoria = get_category_for_activity(act)
                if categoria in counts:
                    counts[categoria] += 1
            
            leyenda_items = [
                ('evaluaciones', 'bg-orange-500', f"Evaluaciones: {counts['evaluaciones']}"),
                # Añadir Control de Lectura a la leyenda si existe
                ('control_lectura', 'bg-fuchsia-600', f"Control de Lectura: {counts.get('control_lectura', 0)}"),
                ('trabajos', 'bg-sky-100', f"Trabajos Prácticos: {counts['trabajos']}"),
                ('eventos', 'bg-purple-100', f"Eventos: {counts['eventos']}"),
                ('tareas', 'bg-teal-100', f"Otras Tareas: {counts['tareas']}"),
                ('libres', 'bg-red-200', f"Días sin clases: {counts['libres']}")
            ]

            for categoria, color, texto in leyenda_items:
                # No mostrar la categoría si no hay actividades de ese tipo
                if ": 0" in texto and categoria != 'evaluaciones': continue

                clase_resaltado = 'bg-slate-300' if categoria == categoria_resaltada_actualmente else 'hover:bg-slate-200'
                contenedor.innerHTML += f"""
                    <li class="leyenda-item flex items-center cursor-pointer p-1 rounded-md {clase_resaltado}" data-category="{categoria}">
                        <span class="w-4 h-4 rounded-full mr-3 {color}"></span>
                        <span class="text-gray-700">{texto}</span>
                    </li>
                """
            
            for item in document.querySelectorAll('.leyenda-item'):
                item.addEventListener('click', create_proxy(resaltar_categoria))

        
        def actualizar_toda_la_pagina():
            renderizar_vista_semanal()
            resaltar_horario()
            renderizar_vista_mensual()
            renderizar_anuncios()
            renderizar_leyenda_y_resumen()
        
        async def cargar_actividades_desde_url():
            global todas_las_actividades
            
            if not GOOGLE_SHEET_URL or "PEGA_AQUÍ" in GOOGLE_SHEET_URL:
                alert("Error de configuración: La URL de Google Sheets no ha sido establecida en el código.")
                # Intentar cargar desde localStorage como respaldo
                datos_guardados = localStorage.getItem('calendarioActividades')
                if datos_guardados:
                    todas_las_actividades = json.loads(datos_guardados)
                    console.log("Datos cargados desde el almacenamiento local como respaldo.")
                return

            try:
                console.log(f"Intentando cargar datos desde: {GOOGLE_SHEET_URL}")
                from pyodide.http import pyfetch
                response = await pyfetch(GOOGLE_SHEET_URL)
                if response.status != 200:
                    raise Exception(f"Error al descargar el archivo: Estado {response.status}")

                contenido_csv = await response.string()
                
                # Procesar el contenido del CSV
                f = io.StringIO(contenido_csv)
                reader = csv.DictReader(f)
                todas_las_actividades = [row for row in reader]
                
                console.log(f"Éxito: Se cargaron {len(todas_las_actividades)} actividades desde la URL.")
                # Guardar en localStorage para acceso offline
                localStorage.setItem('calendarioActividades', json.dumps(todas_las_actividades))

            except Exception as e:
                console.error(f"Fallo al cargar desde la URL: {e}")
                console.log("Intentando cargar desde el almacenamiento local...")
                # Si falla la carga desde la red, intentar cargar desde localStorage
                datos_guardados = localStorage.getItem('calendarioActividades')
                if datos_guardados:
                    todas_las_actividades = json.loads(datos_guardados)
                    console.log("Datos cargados desde el almacenamiento local.")
                    alert("No se pudo conectar para obtener las últimas actividades. Mostrando la última versión guardada.")
                else:
                    console.log("No hay datos en el almacenamiento local.")
                    alert("Error: No se pudieron cargar las actividades y no hay datos guardados localmente.")


        def cambiar_tema(e):
            theme = e.target.value
            document.body.className = f"p-4 transition-colors duration-300 {theme}"
            localStorage.setItem('calendarioTheme', theme)

        def aplicar_tema_guardado():
            theme = localStorage.getItem('calendarioTheme')
            if theme:
                document.body.className = f"p-4 transition-colors duration-300 {theme}"
                document.getElementById('theme-selector').value = theme

        async def main():
            aplicar_tema_guardado()
            await cargar_actividades_desde_url()
            actualizar_toda_la_pagina()

            theme_selector = document.getElementById('theme-selector')

            # Listeners para cerrar el modal
            modal = document.getElementById('activity-modal')
            modal.addEventListener('click', create_proxy(cerrar_modal))
            document.getElementById('modal-close-btn').addEventListener('click', create_proxy(cerrar_modal))

            # Listener para el selector de tema
            theme_selector.addEventListener('change', create_proxy(cambiar_tema))

        # Ejecutar la función principal al cargar la página
        asyncio.ensure_future(main())
    </script>
</body>

</html>